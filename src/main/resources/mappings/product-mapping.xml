<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PRODUCT">

    <!-- 상품 등록 -->
    <insert id="INSERT_PRODUCT"
        parameterType="ProductVO"
        useGeneratedKeys="true"
        keyProperty="productIdx">
        INSERT INTO Products (
            category,
            subCategory,
            product_Name,
            price,
            reg_Date,
            product_Desc,
            product_main_img,
            product_size_img,
            discount_rate,
            is_recommended
        )
        VALUES (
            #{category},
            #{subCategory},
            #{productName},
            #{price},
            #{regDate},
            #{productDesc},
            #{productMainImg},
            #{productSizeImg},
            #{discountRate},
            #{isRecommended}
        )
    </insert>

    <!-- 상품 이미지 등록 -->
    <insert id="INSERT_PRODUCT_IMG"
        parameterType="ProductImgVO">
        INSERT INTO ProductImg (
            product_Idx,
            product_Img,
            product_Img_Order
        )
        VALUES (
            #{productIdx},
            #{productImg},
            #{productImgOrder}
        )
    </insert>
    
    
    <!-- 상품 이미지 등록 -->
    <insert id="INSERT_PRODUCT_DESC_IMG"
        parameterType="ProductDescImgVO">
        INSERT INTO ProductDescImg (
            product_Idx,
            product_Desc_Img,
            product_Desc_Img_Order
        )
        VALUES (
            #{productIdx},
            #{productDescImg},
            #{productDescImgOrder}
        )
    </insert>

	<!-- 상품 옵션 등록 -->
	<insert id="INSERT_PRODUCT_OPTION"
		parameterType="ProductOptionVO">
		INSERT INTO ProductOption (
		product_Idx,
		color,
		size,
		stock
		)
		VALUES (
		#{productIdx},
		#{color},
		#{size},
		#{stock}
		)
	</insert>

	<!-- 옵션 조회 -->
	<select id="SELECT_PRODUCT_OPTIONS"
	        parameterType="int"
	        resultType="com.mbcTeam.product.ProductOptionVO">
	    SELECT option_Idx AS optionIdx,
	           product_Idx AS productIdx,
	           color,
	           size,
	           stock
	    FROM ProductOption
	    WHERE product_Idx = #{productIdx}
	</select>

	<sql id = "searchInclude">
		<where>       
        <if test="search == 'code'">
            AND INSTR(product_Idx, #{keyword}) > 0
        </if>
        <if test="search == 'name'">
            AND INSTR(product_Name, #{keyword}) > 0
        </if>
		</where>
	</sql>


    <!-- 상품 목록 조회 -->
    <select id="SELECT_ADMIN_PRODUCT_LIST"
        resultType="ProductVO">
        SELECT * FROM Products 
        <include refid="searchInclude"/>
        <![CDATA[
        	order by product_Idx desc limit #{startIdx}, #{pageSize}
        ]]>
    </select>
    
    <update id="UPDATE_PRODUCTS_STATUS" parameterType="ProductVO">
    	UPDATE Products 
    	<set>
    		<choose>
    			<when test="productStatus == 'is_recommended'">
    				is_Recommended = #{productStatusValue}
    			</when>
    			<when test="productStatus == 'sale'">
    				discount_rate = #{productStatusValue}
    			</when>
    		</choose>    	
    	</set>
    	WHERE product_idx in
    	<foreach item="Idx" collection="productIdxs" open="(" separator="," close=")">
    		#{Idx}
    	</foreach>
    </update>
    
    <select id="EDIT_PRODUCT" resultType="ProductVO">
    	SELECT * FROM Products 
    	WHERE product_idx = ${productIdx}
    </select>
    
    <select id="EDIT_PRODUCT_IMG" parameterType="int" resultType="ProductImgVO">
    	SELECT * FROM ProductImg 
    	WHERE product_idx = ${value}
    </select>

    <select id="EDIT_PRODUCT_DESC_IMG" parameterType="int" resultType="ProductDescImgVO">
    	SELECT * FROM ProductDescImg 
    	WHERE product_idx = ${value}
    </select>

    <select id="EDIT_PRODUCT_OPTION" parameterType="int" resultType="ProductOptionVO">
    	SELECT * FROM ProductOption
    	WHERE product_idx = ${value}
    </select>


    <!-- 전체 상품 조회 -->
    <select id="SELECT_ALL_PRODUCTS"
        resultType="com.mbcTeam.product.ProductVO">
        SELECT p.product_Idx,
               p.category,
               p.subCategory,
               p.product_Name,
               p.price,
               p.reg_Date,
               p.product_Desc,
               p.discount_rate,
               p.is_Recommended
        FROM Products p
        ORDER BY p.reg_Date DESC
    </select>
    
    <select id="TOTAL_COUNT" parameterType="ProductVO" resultType="int">
    	select count(*) as totalCount from Products
    	<include refid="searchInclude"/>
    </select>
	<select id="SELECT_PRODUCT_OPTION_BY_ID" parameterType="int"
		resultType="com.mbcTeam.product.ProductOptionVO">
		SELECT 	option_Idx AS optionIdx,
				product_Idx AS productIdx,
				color,
				size,
				stock
		FROM ProductOption
		WHERE option_Idx = #{optionIdx}
	</select>




	<!-- 상품 목록 조회 -->
	<select id="SELECT_PRODUCT_LIST"
		resultType="com.mbcTeam.product.ProductVO">
		SELECT p.product_Idx,
		p.category,
		p.subCategory,
		p.product_Name,
		p.price,
		p.reg_Date,
		p.product_Desc,
		p.discount_rate,
		p.is_Recommended,
		mainImg.product_Img AS pMainImgPath,
		sizeImg.product_Img AS pSizeImgPath
		FROM Products p
		LEFT JOIN ProductImg mainImg
		ON p.product_Idx = mainImg.product_Idx AND mainImg.product_Img_Order = 1
		LEFT JOIN ProductImg sizeImg
		ON p.product_Idx = sizeImg.product_Idx AND sizeImg.product_Img_Order = 2
		ORDER BY p.reg_Date DESC
	</select>

	<!-- 상품 상세 조회 (사용자용) -->
	<select id="SELECT_PRODUCT_DETAIL_USER" parameterType="int"
		resultType="com.mbcTeam.product.ProductVO">
		SELECT p.product_Idx,
		p.category,
		p.subCategory,
		p.product_Name,
		p.price,
		p.reg_Date,
		p.product_Desc,
		p.discount_Rate,
		p.is_Recommended,
		mainImg.product_Img AS pMainImgPath,
		sizeImg.product_Img AS pSizeImgPath
		FROM Products p
		LEFT JOIN ProductImg mainImg
		ON p.product_Idx = mainImg.product_Idx AND mainImg.product_Img_Order = 1
		LEFT JOIN ProductImg sizeImg
		ON p.product_Idx = sizeImg.product_Idx AND sizeImg.product_Img_Order = 2
		WHERE p.product_Idx = #{productIdx}
	</select>


	<!-- 카테고리별 상품 조회 -->
	<select id="SELECT_BY_CATEGORY" parameterType="string"
		resultType="com.mbcTeam.product.ProductVO">
		SELECT p.product_Idx,
		p.category,
		p.subCategory,
		p.product_Name,
		p.price,
		p.reg_Date,
		p.product_Desc,
		p.discount_rate,
		p.is_Recommended
		FROM Products p
		WHERE p.category = #{category}
		ORDER BY p.reg_Date DESC
	</select>


	<!-- 리뷰 조회 -->
	<select id="SELECT_PRODUCT_REVIEWS" parameterType="int"
		resultType="com.mbcTeam.user.ReviewVO">
		SELECT r.review_Idx,
		r.product_Idx,
		r.user_Idx,
		r.user_Name,
		r.review,
		r.Rating,
		r.is_Hide,
		r.reg_Date
		FROM Reviews r
		WHERE
		r.product_Idx = #{productIdx}
		ORDER BY r.reg_Date DESC
	</select>



</mapper>
