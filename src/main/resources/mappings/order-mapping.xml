<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ORDER">


 <!-- 주문 등록 -->
  <insert id="insertOrder" parameterType="com.mbcTeam.order.OrderVO">
    INSERT INTO Orders (
        user_Idx, total_Price, receiver, delivery_Phone, address, extra_Address, zipcode, order_Date
    )
    VALUES (
        #{userIdx}, #{totalPrice}, #{recevier}, #{deliveryPhone}, #{address}, #{extraAddress}, #{zipcode}, NOW()
    )
  </insert>



  <!-- 주문 상세 등록 -->
  <insert id="insertOrderItem" parameterType="com.mbcTeam.order.OrderItemVO">
    INSERT INTO OrderItems ( order_Idx, product_Idx, category, subCategory, product_Name,
       						 price, discount_rate, color, size, quantity, product_main_img
    )
    VALUES (#{orderIdx}, #{productIdx}, #{category}, #{subCategory}, #{productName}, #{price}, #{discountRate},
       	    #{color}, #{size}, #{quantity}, #{productMainImg} )
  </insert>

  <!-- 주문 상세 조회 -->
  <select id="selectOrderItems" parameterType="long" resultType="com.mbcTeam.order.OrderItemVO">
    SELECT 
        item_Idx AS itemIdx,
        order_Idx AS orderIdx,
        product_Idx AS productIdx,
        category,
        subCategory,
        product_Name AS productName,
        price,
        discount_rate AS discountRate,
        color,
        size,
        quantity,
        product_main_img AS productMainImg
    FROM OrderItems
    WHERE order_Idx = #{orderIdx}
  </select>




  <!-- 주문 수정 -->
  <update id="updateOrder" parameterType="com.mbcTeam.order.OrderVO">
    UPDATE Orders
    SET total_Price = #{totalPrice},
        receiver = #{recevier},
        delivery_Phone = #{deliveryPhone},
        address = #{address},
        extra_Address = #{extraAddress},
        zipcode = #{zipcode}
    WHERE order_Idx = #{orderIdx}
  </update>

  <!-- 주문 삭제 -->
  <delete id="deleteOrder" parameterType="com.mbcTeam.order.OrderVO">
    DELETE FROM Orders WHERE order_Idx = #{orderIdx}
  </delete>

  <!-- 주문 조회 -->
  <select id="selectOrder" parameterType="com.mbcTeam.order.OrderVO" resultType="com.mbcTeam.order.OrderVO">
    SELECT order_Idx AS orderIdx,
           user_Idx AS userIdx,
           total_Price AS totalPrice,
           receiver AS recevier,
           delivery_Phone AS deliveryPhone,
           address,
           extra_Address AS extraAddress,
           zipcode,
           order_Date AS orderDate
    FROM Orders
    WHERE user_Idx = #{userIdx}
  </select>
   
   	<!-- 차트 월별 매출통계용 -->
	<select id="getMonthlySales" resultType="map">
		SELECT
			DATE_FORMAT(order_Date, '%m') as MONTH,
			SUM(total_Price) as TOTAL_SUM
		FROM Orders
		WHERE DATE_FORMAT(order_Date, '%Y') = #{year}
		GROUP BY MONTH
		ORDER BY MONTH
	</select>   
   
   <select id="getCategorySales" resultType="map">
   SELECT 
	    OI.category as CATEGORY,
	    SUM(
	        CASE 
	            WHEN OI.discount_rate > 0 
	            THEN OI.price * (1 - OI.discount_rate / 100) * OI.quantity
	            ELSE OI.price * OI.quantity
	        END
	    ) as TOTAL_SUM
	FROM OrderItems OI
	JOIN Orders O ON OI.order_Idx = O.order_Idx
	WHERE DATE_FORMAT(O.order_Date, '%Y') = #{year}
	  AND DATE_FORMAT(O.order_Date, '%m') = #{month}
	GROUP BY OI.category
	ORDER BY TOTAL_SUM DESC;
   </select>
   
   
   
</mapper>
