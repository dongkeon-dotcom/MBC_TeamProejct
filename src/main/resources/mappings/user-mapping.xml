<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="USER">

    <insert id="INSERT" parameterType="com.mbcTeam.user.UserVO">
        INSERT INTO users (
            id, password, user_Name, user_Phone, user_Role, is_easy_login, is_deleted, reg_Date
        ) VALUES (
            #{id}, #{password}, #{userName}, #{userPhone}, #{userRole}, #{easyLogin}, #{deleted}, NOW()
        )
    </insert>
<select id="LOGIN" parameterType="com.mbcTeam.user.UserVO" resultType="com.mbcTeam.user.UserVO">
    SELECT  
       user_idx  AS userIdx, id,  password, user_Name AS userName, user_Phone  AS userPhone,   user_Role AS userRole, is_easy_login  AS easyLogin,   is_deleted     AS deleted,     reg_Date       AS regDate      FROM users 
    WHERE id = #{id} 
      AND password = #{password} 
      AND is_deleted = 0               </select>

    <select id="getById" parameterType="com.mbcTeam.user.UserVO" resultType="com.mbcTeam.user.UserVO">
        SELECT
       user_idx       AS userIdx,
            user_email     AS id,
            user_pw        AS password,
            user_name      AS userName,
            user_phone     AS userPhone,
            user_role      AS userRole,
            easy_login     AS easyLogin,
            deleted        AS deleted,
            user_reg_date  AS regDate
        FROM users
        WHERE userIdx = #{userIdx}
    </select>

    <update id="delete" parameterType="com.mbcTeam.user.UserVO">
        UPDATE users
        SET deleted = true
        WHERE user_Idx = #{userIdx}
    </update>

    <select id="countByEmail" parameterType="com.mbcTeam.user.UserVO" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE id = #{id}
    </select>

    <select id="getByEmail" parameterType="com.mbcTeam.user.UserVO" resultType="com.mbcTeam.user.UserVO">
        SELECT
            user_Idx        AS userIdx,
            id     AS id,
            password        AS password,
            userName      AS userName,
            userPhone     AS userPhone,
            userRole      AS userRole,
            isEasyLogin     AS easyLogin,
            isDeleted        AS deleted,
            regDate  AS regDate
        FROM users
        WHERE id = #{id}
    </select>




 <update id="UPDATE_USER" parameterType="com.mbcTeam.user.UserVO">
        UPDATE users
        SET
            user_Name  = #{userName},
            user_phone = #{userPhone},
            password   = #{password}
        WHERE user_Idx = #{userIdx}
    </update>


<select id="GET_USER_BY_ID" parameterType="String" resultType="com.mbcTeam.user.UserVO">
    SELECT  
        user_Idx as userIdx,
        id, 
        password, 
        user_Name      AS userName,
        user_Phone     AS userPhone,
        user_Role      AS userRole, 
        is_easy_login  AS easyLogin,
        is_deleted     AS deleted,
        reg_Date       AS regDate
    FROM users 
    WHERE id = #{id}  AND is_deleted = 0
</select>

<!-- 마이페이지 회원정보 수정에서 주소를 가져오기 위한 매퍼  -->
<select id="getDelivery" parameterType="long" resultType="com.mbcTeam.shop.DeliveryVO">
    SELECT 
        delivery_Idx AS deliveryIdx,
        user_Idx AS userIdx,
        delivery_Name AS deliveryName,
        Receiver AS Receiver,
        delivery_Phone AS deliveryPhone,
        address AS address,
        Extra_Address AS extraAddress,
        Zipcode AS zipcode,
        is_Default_Address AS isDefaultAddress
    FROM Delivery 
    WHERE user_Idx = #{userIdx} 
      AND is_Default_Address = 1
</select>


<sql id = "searchInclude">
	<where>       
       <if test="search == 'code'">
           AND INSTR(${prefix}user_idx, #{keyword}) > 0
       </if>
       <if test="search == 'name'">
           AND INSTR(${prefix}user_Name, #{keyword}) > 0
       </if>
	</where>
</sql>


<!-- ADMIN 관리자_회원관리 페이지 용  -->
<select id="getUserManagement" resultType="com.mbcTeam.dto.UserManagementDTO">
	select
		u.reg_date,
		u.user_idx,
		u.id,
		u.user_phone,
		u.user_name,
		IFNULL(CONCAT(d.address,' ',d.Extra_Address), 'NONE') AS full_address,
		IFNULL(SUM(o.total_Price), '0') AS total_spent
	FROM users u
	LEFT JOIN Delivery d ON u.user_idx = d.user_Idx AND d.is_Default_Address=1
	LEFT JOIN Orders o ON u.user_idx = o.user_Idx 
	<include refid="searchInclude">
		<property name="prefix" value="u."/>
	</include>
	GROUP BY
		u.user_idx,
		d.address,
		d.Extra_Address
	<![CDATA[
	ORDER BY u.user_idx desc limit #{startIdx}, #{pageSize}
	]]>
</select>

<select id="GET_USER_TOTAL_COUNT" parameterType="com.mbcTeam.dto.UserManagementDTO" resultType="int">
	select count(*) as totalCount from users u
	<include refid="searchInclude">
		<property name="prefix" value=""/>
	</include>
</select>




</mapper>